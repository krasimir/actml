!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).actml=f()}}(function(){return function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){return o(e[i][1][r]||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}({1:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.default=function(func,props,children){if("function"!=typeof func)throw new Error('ActML element expects a function. "'+func+'" given instead.');return{__actml:!0,__used:0,__running:!1,id:null,props:props,name:function(func){if(func.name)return func.name;var result=/^function\s+([\w\$]+)\s*\(/.exec(func.toString());return result?result[1]:"unknown"}(func),children:children,initialize:function(id,argument_1){var used=1<arguments.length&&void 0!==argument_1?argument_1:0;this.id=id,this.__used=used,this.__running=!1},mergeProps:function(newProps){this.props=Object.assign({},this.props,newProps)},used:function(){return this.__used},isRunning:function(){return this.__running},enter:function(){this.__running=!0},consume:function(){return func(this.props)},out:function(){this.__used+=1,this.__running=!1}}}},{}],2:[function(require,module,exports){"use strict";function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=function(processor){return function(initialValue){var _ref3,id="c"+ ++ids;return _defineProperty(_ref3={},PUBLIC_CONTEXT_KEY,function(){return resolveContext(processor.node(),id)||initialValue}),_defineProperty(_ref3,"Provider",function(_ref){var value=_ref.value,children=_ref.children,node=processor.node();return node[CONTEXT_KEY]||(node[CONTEXT_KEY]={}),node[CONTEXT_KEY][id]=value,children}),_defineProperty(_ref3,"Consumer",function(_ref2){(0,_ref2.children)(resolveContext(processor.node(),id)||initialValue)}),_ref3}};var CONTEXT_KEY="__CONTEXT_KEY__",PUBLIC_CONTEXT_KEY=exports.PUBLIC_CONTEXT_KEY="__PUBLIC_CONTEXT_KEY__",ids=0;function resolveContext(node,id,argument_2){var stack=2<arguments.length&&void 0!==argument_2?argument_2:[];return stack.push(node.element.name),node[CONTEXT_KEY]&&id in node[CONTEXT_KEY]?node[CONTEXT_KEY][id]:node.parent?resolveContext(node.parent,id,stack):void console.warn("A context consumer is used with no provider.\n  Stack:\n"+stack.map(function(name){return"    <"+name+">"}).join("\n"))}},{}],3:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=function(){function processNode(node){(currentNode=node).enter(),node.rerun=function(){return processNode(node)},node.element.mergeProps({children:function(node,processNode){var f=function(){var _arguments=arguments,children=node.element.children;if(children&&0<children.length){for(var queueItemsToAdd=[],results=[],childrenQueue=(0,_Queue2.default)("  "+node.element.name+":children"),_loop=function(i){var _children$i;if((0,_isActMLElement2.default)(children[i]))(_children$i=children[i]).mergeProps.apply(_children$i,_arguments),queueItemsToAdd.push(function(){return processNode(node.addChildNode(children[i]))});else if("function"==typeof children[i]){var funcResult=children[i].apply(children,_arguments);(0,_isActMLElement2.default)(funcResult)?queueItemsToAdd.push(function(){return processNode(node.addChildNode(funcResult))}):results.push(funcResult)}else results.push(children[i])},i=0;i<children.length;i++)_loop(i);return queueItemsToAdd.reverse().forEach(function(func){childrenQueue.prependItem(CHILD,func,function(r){return results.push(r)})}),childrenQueue.process(),childrenQueue.onDone(function(){return results})}};return f[CHILDREN]=!0,f}(node,processNode)});var results={},queue=(0,_Queue2.default)(" "+node.element.name);return queue.add(CONSUME,function(){return node.element.consume()},function(result){return results[CONSUME]=result}),queue.add(PROCESS_RESULT,function(){var consumption=results[CONSUME];if((0,_isActMLElement2.default)(consumption))queue.prependItem(RETURNED_ELEMENT,function(){return processNode(node.addChildNode(consumption))},function(result){return results[RETURNED_ELEMENT]=result});else if(isGenerator(consumption)){var generator=consumption;queue.prependItem(RETURNED_ELEMENT,function(){return new Promise(function(generatorDone){var genResult=void 0;!function iterate(value){if((genResult=generator.next(value)).done)if((0,_isActMLElement2.default)(genResult.value)){var _res=processNode(node.addChildNode(genResult.value));isPromise(_res)?_res.then(function(r){return generatorDone(r)}):generatorDone(_res)}else generatorDone(genResult.value);else if((0,_isActMLElement2.default)(genResult.value)){var res=processNode(node.addChildNode(genResult.value));isPromise(res)?res.then(function(r){return iterate(r)}):iterate(res)}}()})},function(result){return results[RETURNED_ELEMENT]=result})}else consumption&&consumption[CHILDREN]&&queue.prependItem(RETURNED_ELEMENT,function(){return consumption()},function(result){results[RETURNED_ELEMENT]=result&&1===result.length?result[0]:result})}),queue.process(),queue.onDone(function(){return node.out(),RETURNED_ELEMENT in results?results[RETURNED_ELEMENT]:results[CONSUME]})}var tree=(0,_Tree2.default)(),currentNode=null;return{node:function(){return currentNode},run:function(element){var rootNode=tree.resolveRoot(element);return processNode(rootNode)},onNodeEnter:function(callback){tree.addNodeEnterCallback(callback)},onNodeOut:function(callback){tree.addNodeOutCallback(callback)},onNodeRemove:function(callback){tree.onNodeRemove(callback)},system:function(){return{tree:tree,reset:function(){currentNode=null,tree.reset(),_usePubSub2.default.clear(),_useState2.default.clear(),_useEffect2.default.clear()}}}}};var _isActMLElement2=_interopRequireDefault(require("./utils/isActMLElement")),_Tree2=_interopRequireDefault(require("./Tree")),_usePubSub2=_interopRequireDefault(require("./hooks/usePubSub")),_useState2=_interopRequireDefault(require("./hooks/useState")),_useEffect2=_interopRequireDefault(require("./hooks/useEffect")),_Queue2=_interopRequireDefault(require("./Queue"));function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var CHILDREN="__ACTML_CHILDREN__",CONSUME="CONSUME",PROCESS_RESULT="PROCESS_RESULT",RETURNED_ELEMENT="RETURNED_ELEMENT",CHILD="CHILD",isGenerator=function(obj){return obj&&"function"==typeof obj.next},isPromise=function(obj){return obj&&"function"==typeof obj.then}},{"./Queue":4,"./Tree":5,"./hooks/useEffect":7,"./hooks/usePubSub":9,"./hooks/useState":11,"./utils/isActMLElement":14}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.default=function(context){var items=[],async=!1,running=!1,release=function(){};return{add:function(type,func,onDone){log(context+":Q: [..."+type+"] ("+(items.length+1)+" total)"),items.push(createItem(type,func,onDone))},prependItem:function(type,func,onDone){log(context+":Q: ["+type+"...] ("+(items.length+1)+" total)"),items=[createItem(type,func,onDone)].concat(function(arr){{if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}}(items))},process:function(lastResult){var _this=this;if(running=!0,0===items.length)return log(context+":Q:done"),running=!1,void release();var item=items.shift();log(context+":Q: "+item.type+"() ("+items.length+" left)");var result=item.func(lastResult);isPromise(result)?(async=!0,result.then(function(asyncResult){item.onDone(asyncResult),_this.process(asyncResult)}).catch(function(error){release(error)})):(item.onDone(result),this.process(result))},onDone:function(getResult){return async?new Promise(function(done,reject){release=function(error){error?reject(error):done(getResult())}}):getResult()},isRunning:function(){return running}}};var log=function(){return null},isPromise=function(obj){return obj&&"function"==typeof obj.then},createItem=function(type,func,argument_2){return{type:type,func:func,onDone:2<arguments.length&&void 0!==argument_2?argument_2:function(){}}}},{}],5:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target};exports.default=function(){var onNodeEnter=[],onNodeOut=[],_onNodeRemove=[],root=createNewNode(),ids=0;function useSameNode(node,newElement){return newElement.initialize(node.element.id,node.element.used()),node.element=newElement,node}function treeDiff(oldElement,newElement){return!(!oldElement||oldElement.name!==newElement.name)&&(!oldElement.props||!newElement.props||oldElement.props.key===newElement.props.key)}function createNewNode(element,parent){return element&&element.initialize("a"+ ++ids),{element:element,children:[],parent:parent,cursor:0,enter:function(){var _this=this;log("-> "+this.element.name),this.element.enter(),onNodeEnter.forEach(function(c){return c(_this)})},out:function(){var _this2=this;log("<- "+this.element.name),this.element.out(),this.cursor<this.children.length&&this.children.splice(this.cursor,this.children.length-this.cursor).forEach(function(removedNode){return _onNodeRemove.forEach(function(c){return c(removedNode)})}),this.cursor=0,onNodeOut.forEach(function(c){return c(_this2)})},addChildNode:function(newElement){var _this3=this,childNode=this.children[this.cursor];if(childNode&&treeDiff(childNode.element,newElement))return this.cursor+=1,useSameNode(childNode,newElement);var newChildNode=createNewNode(newElement,this);return this.children[this.cursor]&&_onNodeRemove.forEach(function(c){return c(_this3.children[_this3.cursor])}),this.children[this.cursor]=newChildNode,this.cursor+=1,newChildNode}}}return{resolveRoot:function(element){return root=treeDiff(root.element,element)?useSameNode(root,element):createNewNode(element)},reset:function(){root=createNewNode(),ids=0},getNumOfElements:function(){return ids},diagnose:function(){return function loopOver(node,argument_1){var ind=1<arguments.length&&void 0!==argument_1?argument_1:0,_ref=node.element.props?node.element.props:{},rest=(_ref.children,function(obj,keys){var target={};for(var i in obj)0<=keys.indexOf(i)||Object.prototype.hasOwnProperty.call(obj,i)&&(target[i]=obj[i]);return target}(_ref,["children"]));return{ind:ind,name:node.element.name,props:_extends({children:"<function children>"},rest),used:node.element.used(),id:node.element.id,children:node.children.map(function(child){return loopOver(child,ind+1)})}}(root)},addNodeEnterCallback:function(callback){onNodeEnter.push(callback)},addNodeOutCallback:function(callback){onNodeOut.push(callback)},onNodeRemove:function(callback){_onNodeRemove.push(callback)}}};var log=function(){return null}},{}],6:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var obj,_isValidHookContext=require("./utils/isValidHookContext"),_isValidHookContext2=(obj=_isValidHookContext)&&obj.__esModule?obj:{default:obj},_Context=require("../Context");exports.default=function(processor){return function(Context){return(0,_isValidHookContext2.default)(processor),Context[_Context.PUBLIC_CONTEXT_KEY]()}}},{"../Context":2,"./utils/isValidHookContext":12}],7:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _fastDeepEqual2=_interopRequireDefault(require("fast-deep-equal")),_isValidHookContext2=_interopRequireDefault(require("./utils/isValidHookContext"));function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var Storage={elements:{},get:function(element){return this.elements[element.id]?this.elements[element.id]:this.elements[element.id]={effects:[],consumer:0}},cleanUp:function(id){this.elements[id]&&delete this.elements[id]}};function resolveEffect(node,effect){var deps=effect.deps,oldDeps=effect.oldDeps,callback=effect.callback;if(void 0===deps)effect.cleanUp=callback();else if(0===deps.length)1===node.element.used()&&(effect.cleanUp=callback());else{(function(oldDeps,newDeps){return!!oldDeps&&(oldDeps.length===newDeps.length&&(0,_fastDeepEqual2.default)(oldDeps,newDeps))})(oldDeps,deps)||(effect.cleanUp=callback())}}var createUseEffectHook=function(processor){return processor.onNodeRemove(function(node){var element=node.element;Storage.get(element).effects.forEach(function(effect){effect.cleanUp&&effect.cleanUp()}),Storage.cleanUp(node.element.id)}),processor.onNodeOut(function(node){var element=node.element,storage=Storage.get(element);0<storage.effects.length&&storage.effects.forEach(function(effect){return resolveEffect(node,effect)})}),function(callback,deps){(0,_isValidHookContext2.default)(processor);var element=processor.node().element,storage=Storage.get(element);if(0===element.used())storage.effects.push(function(callback,deps){return{callback:callback,deps:deps}}(callback,deps));else{var index=storage.consumer;storage.consumer=index<storage.effects.length-1?storage.consumer+1:0,function(effect,callback,deps){effect.callback=callback,effect.oldDeps=effect.deps,effect.deps=deps}(storage.effects[index],callback,deps)}}};(exports.default=createUseEffectHook).clear=function(){Storage.elements={}}},{"./utils/isValidHookContext":12,"fast-deep-equal":15}],8:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var obj,_isValidHookContext=require("./utils/isValidHookContext"),_isValidHookContext2=(obj=_isValidHookContext)&&obj.__esModule?obj:{default:obj};exports.default=function(processor){return function(){return(0,_isValidHookContext2.default)(processor),processor.node().element}}},{"./utils/isValidHookContext":12}],9:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=createUsePubSubHook;var obj,_isValidHookContext=require("./utils/isValidHookContext"),_isValidHookContext2=(obj=_isValidHookContext)&&obj.__esModule?obj:{default:obj};var subscribers={},subscribe=function(element,type,callback){return subscribers[type]||(subscribers[type]={}),subscribers[type][element.id]=callback,function(){delete subscribers[type][element.id]}},publish=function(type,payload){subscribers[type]&&Object.keys(subscribers[type]).forEach(function(id){subscribers[type][id](payload)})};function createUsePubSubHook(processor){return processor.onNodeRemove(function(node){Object.keys(subscribers).forEach(function(type){subscribers[type][node.element.id]&&delete subscribers[type][node.element.id]})}),function(scopedElement){(0,_isValidHookContext2.default)(processor);var node=processor.node(),el=scopedElement||node.element;return{subscribe:function(){for(var _len=arguments.length,params=Array(_len),_key=0;_key<_len;_key++)params[_key]=arguments[_key];return subscribe.apply(void 0,[el].concat(params))},publish:function(){return publish.apply(void 0,arguments)},subscribers:subscribers}}}createUsePubSubHook.clear=function(){subscribers={}}},{"./utils/isValidHookContext":12}],10:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _slicedToArray=function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return function(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i.return&&_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")};exports.default=function(useState){return function(reducer,initialState){var _useState=useState(initialState),_useState2=_slicedToArray(_useState,2),state=_useState2[0],setState=_useState2[1],dispatch=function(action){return setState(reducer(state(),action))};return[state,dispatch,function(dispatch){return function(_ref){var action=_ref.action,propsToAction=_ref.propsToAction,rest=function(obj,keys){var target={};for(var i in obj)0<=keys.indexOf(i)||Object.prototype.hasOwnProperty.call(obj,i)&&(target[i]=obj[i]);return target}(_ref,["action","propsToAction"]);if(action)dispatch(action);else{if(!propsToAction)throw new Error('<Dispatch> expects "action" or "propsToAction" prop.');dispatch(propsToAction(rest))}}}(dispatch),function(){return state()}]}}},{}],11:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=createUseStateHook;var obj,_isValidHookContext=require("./utils/isValidHookContext"),_isValidHookContext2=(obj=_isValidHookContext)&&obj.__esModule?obj:{default:obj};var Storage={elements:{},get:function(element){return this.elements[element.id]?this.elements[element.id]:this.elements[element.id]={states:[],consumer:0}},cleanUp:function(id){this.elements[id]&&delete this.elements[id]}};function createUseStateHook(processor){return processor.onNodeRemove(function(node){return Storage.cleanUp(node.element.id)}),function(initialState){(0,_isValidHookContext2.default)(processor);var node=processor.node(),element=node.element,storage=Storage.get(element),index=void 0;return 0===element.used()?(storage.states.push(initialState),index=storage.states.length-1):(index=storage.consumer,storage.consumer=index<storage.states.length-1?storage.consumer+1:0),[function(){return storage.states[index]},function(newState){return storage.states[index]=newState,element.isRunning()||node.rerun(),newState}]}}createUseStateHook.clear=function(){Storage.elements={}}},{"./utils/isValidHookContext":12}],12:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=function(processor){if(!processor)throw new Error("Something terribly wrong happened. The hook factory function is called without a processor.");if(!processor.node())throw new Error("Hooks must be called in the context of an ActML element.")}},{}],13:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createRuntime=createRuntime;var _Processor2=_interopRequireDefault(require("./Processor")),_isActMLElement2=_interopRequireDefault(require("./utils/isActMLElement")),_ActElement2=_interopRequireDefault(require("./ActElement")),_useElement2=_interopRequireDefault(require("./hooks/useElement")),_usePubSub2=_interopRequireDefault(require("./hooks/usePubSub")),_useState2=_interopRequireDefault(require("./hooks/useState")),_useReducer2=_interopRequireDefault(require("./hooks/useReducer")),_useEffect2=_interopRequireDefault(require("./hooks/useEffect")),_useContext2=_interopRequireDefault(require("./hooks/useContext")),_Context2=_interopRequireDefault(require("./Context"));function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function createRuntime(){var processor=(0,_Processor2.default)();var useElement=(0,_useElement2.default)(processor),useState=(0,_useState2.default)(processor),usePubSub=(0,_usePubSub2.default)(processor),useReducer=(0,_useReducer2.default)(useState),useEffect=(0,_useEffect2.default)(processor),useContext=(0,_useContext2.default)(processor),createContext=(0,_Context2.default)(processor);return{A:function(func,props){for(var _len=arguments.length,children=Array(2<_len?_len-2:0),_key=2;_key<_len;_key++)children[_key-2]=arguments[_key];return(0,_ActElement2.default)(func,props,children)},run:function(element){if(!(0,_isActMLElement2.default)(element))throw new Error("ActML element expected. Instead "+element.toString()+" passed.");return processor.run(element)},Fragment:function(_ref){return _ref.children},processor:processor,useElement:useElement,usePubSub:usePubSub,useState:useState,useReducer:useReducer,useEffect:useEffect,useContext:useContext,createContext:createContext}}var runtime=createRuntime();module.exports=runtime,module.exports.createRuntime=createRuntime()},{"./ActElement":1,"./Context":2,"./Processor":3,"./hooks/useContext":6,"./hooks/useEffect":7,"./hooks/useElement":8,"./hooks/usePubSub":9,"./hooks/useReducer":10,"./hooks/useState":11,"./utils/isActMLElement":14}],14:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=function(element){return element&&!0===element.__actml}},{}],15:[function(require,module,exports){"use strict";var isArray=Array.isArray,keyList=Object.keys,hasProp=Object.prototype.hasOwnProperty;module.exports=function equal(a,b){if(a===b)return!0;if(a&&b&&"object"==typeof a&&"object"==typeof b){var i,length,key,arrA=isArray(a),arrB=isArray(b);if(arrA&&arrB){if((length=a.length)!=b.length)return!1;for(i=length;0!=i--;)if(!equal(a[i],b[i]))return!1;return!0}if(arrA!=arrB)return!1;var dateA=a instanceof Date,dateB=b instanceof Date;if(dateA!=dateB)return!1;if(dateA&&dateB)return a.getTime()==b.getTime();var regexpA=a instanceof RegExp,regexpB=b instanceof RegExp;if(regexpA!=regexpB)return!1;if(regexpA&&regexpB)return a.toString()==b.toString();var keys=keyList(a);if((length=keys.length)!==keyList(b).length)return!1;for(i=length;0!=i--;)if(!hasProp.call(b,keys[i]))return!1;for(i=length;0!=i--;)if(!equal(a[key=keys[i]],b[key]))return!1;return!0}return a!=a&&b!=b}},{}]},{},[13])(13)});